# E2E tests for GitHub and Gitea. Enable platforms via repository/environment variables:
# - GitHub: always runs (uses TEST_GITHUB_TOKEN and vars.TEST_GITHUB_REPO when set).
# - Gitea: runs only when vars.TEST_GITEA_REPO is set (and TEST_GITEA_TOKEN in TEST env).
name: E2E Tests

on:
  workflow_call:  # Called by release workflow
  workflow_dispatch:  # Manual trigger only

concurrency:
  # Fallbacks so group is valid on GitHub, Gitea, and act (e.g. workflow_dispatch has no ref)
  group: ${{ github.workflow || 'E2E Tests' }}-${{ github.ref || github.sha }}
  cancel-in-progress: true

permissions:
  contents: write  # Required to create tags and releases

jobs:
  e2e:
    runs-on: ubuntu-latest
    environment: TEST
    # Run GitHub always; run Gitea only when TEST_GITEA_REPO is configured.
    # Note: job-level "if" with matrix context can fail when workflow is called; we skip Gitea in step instead.
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: github
            repo: ${{ vars.TEST_GITHUB_REPO || 'LiquidLogicLabs/git-action-release-tests' }}
            baseUrl: ''
            repoPath: ${{ vars.TEST_GITHUB_REPO || 'LiquidLogicLabs/git-action-release-tests' }}
          - platform: gitea
            repo: ${{ vars.TEST_GITEA_REPO || 'skip' }}
            baseUrl: ${{ vars.TEST_GITEA_BASE_URL || 'https://git.ravenwolf.org' }}
            repoPath: ${{ vars.TEST_GITEA_REPO_PATH || vars.TEST_GITEA_REPO || 'skip' }}
    env:
      TEST_TOKEN: ${{ matrix.platform == 'github' && secrets.TEST_GITHUB_TOKEN || secrets.TEST_GITEA_TOKEN }}
      GITEA_RELEASE_LOOKUP_BASE_DELAY_MS: ${{ matrix.platform == 'gitea' && '1500' || '' }}
      GITEA_RELEASE_LOOKUP_MAX_DELAY_MS: ${{ matrix.platform == 'gitea' && '12000' || '' }}
      GITEA_ACTIONS: ${{ matrix.platform == 'gitea' && 'true' || '' }}
      GITEA_WORKSPACE: ${{ matrix.platform == 'gitea' && github.workspace || '' }}
      GITEA_SERVER_URL: ${{ matrix.platform == 'gitea' && matrix.baseUrl || '' }}
      GITEA_REPOSITORY: ${{ matrix.platform == 'gitea' && matrix.repoPath || '' }}
      GITEA_BASE_URL: ${{ matrix.platform == 'gitea' && matrix.baseUrl || '' }}
      GITHUB_SERVER_URL: ${{ matrix.platform == 'gitea' && matrix.baseUrl || '' }}
      GITHUB_REPOSITORY: ${{ matrix.platform == 'gitea' && matrix.repoPath || '' }}
    steps:
      - name: Skip if Gitea not configured
        id: skip
        run: |
          if [ "${{ matrix.platform }}" = "gitea" ] && [ -z "${{ vars.TEST_GITEA_REPO }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout action code
        if: steps.skip.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Install GitHub CLI (GitHub only)
        if: steps.skip.outputs.skip != 'true'
        if: matrix.platform == 'github'
        uses: sersoft-gmbh/setup-gh-cli-action@v3

      - name: Install Tea CLI (Gitea only)
        if: steps.skip.outputs.skip != 'true' && matrix.platform == 'gitea'
        uses: LiquidLogicLabs/git-action-install-gitea-tea@v2
        with:
          version: 'latest'
          token: ${{ secrets.TEST_GITEA_TOKEN }}
          repo: ${{ matrix.baseUrl }}

      - name: Generate unique test tag
        if: steps.skip.outputs.skip != 'true'
        id: test_tag
        run: |
          TEST_TAG="test-e2e-${{ matrix.platform }}-${{ github.run_id }}-${{ github.run_attempt }}-$(date +%s)"
          echo "tag=$TEST_TAG" >> $GITHUB_OUTPUT
          echo "Generated test tag: $TEST_TAG"

      - name: Test - Create release
        if: steps.skip.outputs.skip != 'true'
        id: create_release
        uses: ./
        with:
          token: ${{ env.TEST_TOKEN }}
          platform: ${{ matrix.platform }}
          repository: ${{ matrix.repo }}
          tag: ${{ steps.test_tag.outputs.tag }}
          name: E2E Test Release ${{ steps.test_tag.outputs.tag }}
          body: This is a test release created by E2E tests
          verbose: true

      - name: Verify release outputs
        if: steps.skip.outputs.skip != 'true'
        run: |
          if [ -z "${{ steps.create_release.outputs.id }}" ]; then
            echo "❌ Release ID is missing"
            exit 1
          fi
          if [ -z "${{ steps.create_release.outputs.html-url }}" ]; then
            echo "❌ Release HTML URL is missing"
            exit 1
          fi
          echo "✅ Release created successfully"
          echo "  ID: ${{ steps.create_release.outputs.id }}"
          echo "  URL: ${{ steps.create_release.outputs.html-url }}"

      - name: Test - Update release
        if: steps.skip.outputs.skip != 'true'
        id: update_release
        uses: ./
        with:
          token: ${{ env.TEST_TOKEN }}
          platform: ${{ matrix.platform }}
          repository: ${{ matrix.repo }}
          tag: ${{ steps.test_tag.outputs.tag }}
          name: E2E Test Release Updated ${{ steps.test_tag.outputs.tag }}
          body: This release has been updated by E2E tests
          allow-updates: true

      - name: Verify update outputs
        if: steps.skip.outputs.skip != 'true'
        run: |
          if [ "${{ steps.update_release.outputs.id }}" != "${{ steps.create_release.outputs.id }}" ]; then
            echo "❌ Release ID changed during update (expected same ID)"
            exit 1
          fi
          echo "✅ Release updated successfully"

      - name: Configure Tea CLI (Gitea only)
        if: steps.skip.outputs.skip != 'true' && matrix.platform == 'gitea'
        run: |
          echo "Configuring Tea CLI for ${{ matrix.baseUrl }}"
          tea login add --name gitea --url "${{ matrix.baseUrl }}" --token "${{ env.TEST_TOKEN }}" || true

      - name: Cleanup - Delete release
        if: always() && steps.skip.outputs.skip != 'true'
        run: |
          if [ "${{ matrix.platform }}" == "github" ]; then
            REPO="${{ matrix.repo }}"
            gh release delete "${{ steps.test_tag.outputs.tag }}" --repo "$REPO" --yes || true
            gh api -X DELETE "/repos/$REPO/git/refs/tags/${{ steps.test_tag.outputs.tag }}" || true
          else
            REPO="${{ matrix.repoPath }}"
            TAG="${{ steps.test_tag.outputs.tag }}"
            echo "Deleting Gitea release: ${TAG} from ${REPO}"
            tea release delete "${TAG}" --confirm --delete-tag --repo "${REPO}" || true
            echo "✅ Cleaned up Gitea release: ${TAG}"
          fi
        env:
          GITHUB_TOKEN: ${{ matrix.platform == 'github' && env.TEST_TOKEN || '' }}
