name: E2E Tests

on:
  workflow_call:  # Called by release workflow
  workflow_dispatch:  # Manual trigger only

permissions:
  contents: write  # Required to create tags and releases

jobs:
  e2e:
    runs-on: ubuntu-latest
    environment: TEST
    continue-on-error: ${{ matrix.platform == 'gitea' }}
    strategy:
      matrix:
        include:
          - platform: github
            repo: ${{ vars.TEST_GITHUB_REPO || 'LiquidLogicLabs/git-action-release-tests' }}
            baseUrl: ''
            repoPath: ${{ vars.TEST_GITHUB_REPO || 'LiquidLogicLabs/git-action-release-tests' }}
          - platform: gitea
            repo: ${{ vars.TEST_GITEA_REPO || 'https://git.ravenwolf.org/l3io/git-action-release-tests' }}
            baseUrl: ${{ vars.TEST_GITEA_BASE_URL || 'https://git.ravenwolf.org' }}
            repoPath: ${{ vars.TEST_GITEA_REPO_PATH || 'l3io/git-action-release-tests' }}
      fail-fast: false  # Continue testing other platforms if one fails
    env:
      TEST_TOKEN: ${{ matrix.platform == 'github' && secrets.TEST_GITHUB_TOKEN || secrets.TEST_GITEA_TOKEN }}
      GITEA_RELEASE_LOOKUP_BASE_DELAY_MS: ${{ matrix.platform == 'gitea' && '1500' || '' }}
      GITEA_RELEASE_LOOKUP_MAX_DELAY_MS: ${{ matrix.platform == 'gitea' && '12000' || '' }}
      # Gitea environment variables (for Gitea platform to emulate Gitea Actions environment)
      GITEA_ACTIONS: ${{ matrix.platform == 'gitea' && 'true' || '' }}
      GITEA_WORKSPACE: ${{ matrix.platform == 'gitea' && github.workspace || '' }}
      GITEA_SERVER_URL: ${{ matrix.platform == 'gitea' && matrix.baseUrl || '' }}
      GITEA_REPOSITORY: ${{ matrix.platform == 'gitea' && matrix.repoPath || '' }}
      GITEA_BASE_URL: ${{ matrix.platform == 'gitea' && matrix.baseUrl || '' }}
      # Gitea Actions compatibility: also set GITHUB_* vars pointing to Gitea
      GITHUB_SERVER_URL: ${{ matrix.platform == 'gitea' && matrix.baseUrl || '' }}
      GITHUB_REPOSITORY: ${{ matrix.platform == 'gitea' && matrix.repoPath || '' }}
    # Run action from committed dist only (no build). Ensures E2E fails if dist is unbundled.
    steps:
      - name: Checkout action code
        uses: actions/checkout@v4

      - name: Setup Go (Gitea only)
        if: matrix.platform == 'gitea'
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Install Tea CLI (Gitea only)
        if: matrix.platform == 'gitea'
        run: |
          # Install Tea CLI using Go (much simpler than downloading binary)
          echo "Installing Tea CLI using Go..."
          go install code.gitea.io/tea@latest
          
          # Verify installation
          echo "Verifying installation..."
          ~/go/bin/tea --version || $(go env GOPATH)/bin/tea --version

      - name: Generate unique test tag
        id: test_tag
        run: |
          TEST_TAG="test-e2e-${{ matrix.platform }}-${{ github.run_id }}-${{ github.run_attempt }}-$(date +%s)"
          echo "tag=$TEST_TAG" >> $GITHUB_OUTPUT
          echo "Generated test tag: $TEST_TAG"

      - name: Test - Create release
        id: create_release
        uses: ./
        with:
          token: ${{ env.TEST_TOKEN }}
          platform: ${{ matrix.platform }}
          repository: ${{ matrix.repo }}
          tag: ${{ steps.test_tag.outputs.tag }}
          name: E2E Test Release ${{ steps.test_tag.outputs.tag }}
          body: This is a test release created by E2E tests
          verbose: true
        # Note: Gitea environment variables are set at the job level via matrix values
        # This allows the action to properly detect Gitea environment when running E2E tests

      - name: Verify release outputs
        run: |
          if [ -z "${{ steps.create_release.outputs.id }}" ]; then
            echo "❌ Release ID is missing"
            exit 1
          fi
          if [ -z "${{ steps.create_release.outputs.html-url }}" ]; then
            echo "❌ Release HTML URL is missing"
            exit 1
          fi
          echo "✅ Release created successfully"
          echo "  ID: ${{ steps.create_release.outputs.id }}"
          echo "  URL: ${{ steps.create_release.outputs.html-url }}"

      - name: Test - Update release
        id: update_release
        uses: ./
        with:
          token: ${{ env.TEST_TOKEN }}
          platform: ${{ matrix.platform }}
          repository: ${{ matrix.repo }}
          tag: ${{ steps.test_tag.outputs.tag }}
          name: E2E Test Release Updated ${{ steps.test_tag.outputs.tag }}
          body: This release has been updated by E2E tests
          allow-updates: true
        # Note: Gitea environment variables are set at the job level via matrix values
        # This allows the action to properly detect Gitea environment when running E2E tests

      - name: Verify update outputs
        run: |
          if [ "${{ steps.update_release.outputs.id }}" != "${{ steps.create_release.outputs.id }}" ]; then
            echo "❌ Release ID changed during update (expected same ID)"
            exit 1
          fi
          echo "✅ Release updated successfully"

      - name: Configure Tea CLI (Gitea only)
        if: matrix.platform == 'gitea'
        run: |
          echo "Configuring Tea CLI for ${{ matrix.baseUrl }}"
          # Configure Tea CLI login non-interactively
          tea login add --name gitea --url "${{ matrix.baseUrl }}" --token "${{ env.TEST_TOKEN }}" || true

      - name: Cleanup - Delete release
        if: always()
        run: |
          if [ "${{ matrix.platform }}" == "github" ]; then
            # GitHub cleanup using GitHub CLI
            REPO="${{ matrix.repo }}"
            gh release delete "${{ steps.test_tag.outputs.tag }}" --repo "$REPO" --yes || true
            gh api -X DELETE "/repos/$REPO/git/refs/tags/${{ steps.test_tag.outputs.tag }}" || true
          else
            # Gitea cleanup using Tea CLI
            REPO="${{ matrix.repoPath }}"
            TAG="${{ steps.test_tag.outputs.tag }}"
            
            echo "Deleting Gitea release: ${TAG} from ${REPO}"
            # Delete release and tag using Tea CLI
            tea release delete "${TAG}" --confirm --delete-tag --repo "${REPO}" || true
            echo "✅ Cleaned up Gitea release: ${TAG}"
          fi
        env:
          GITHUB_TOKEN: ${{ matrix.platform == 'github' && env.TEST_TOKEN || '' }}
